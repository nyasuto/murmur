name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-check:
    name: å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x, 22.x, 24.x]
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.js ${{ matrix.node-version }} ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: make install
      
    - name: ç’°å¢ƒæƒ…å ±ã‚’è¡¨ç¤º
      run: make env-info
      
    - name: ESLintãƒã‚§ãƒƒã‚¯
      run: make lint
      continue-on-error: true
      
    - name: ã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯
      run: make type-check
      continue-on-error: true
      
    - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: make test
      continue-on-error: true
      
    - name: ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
      run: make build
      continue-on-error: true

  security-scan:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm install
      
    - name: è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
      run: npm audit --audit-level=moderate
      continue-on-error: true

  build-test:
    name: ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm install
      
    - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
      run: npm run build
      continue-on-error: true
      
    - name: ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: murmur-linux-build
        path: dist/
        retention-days: 7
      continue-on-error: true

  pr-quality-gate:
    name: PRå“è³ªã‚²ãƒ¼ãƒˆ
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [quality-check, security-scan]
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: make install
      
    - name: PRæº–å‚™ãƒã‚§ãƒƒã‚¯
      run: make pr-ready
      continue-on-error: true
      
    - name: PRå“è³ªãƒ¬ãƒãƒ¼ãƒˆ
      run: |
        echo "## ðŸŽ¯ PRå“è³ªãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: å®Ÿè¡Œæ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: å®Ÿè¡Œæ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ãƒžãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ‰: å®Ÿè¡Œæ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ ã“ã®PRã¯ãƒžãƒ¼ã‚¸æº–å‚™å®Œäº†ã§ã™ï¼" >> $GITHUB_STEP_SUMMARY