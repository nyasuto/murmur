name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (ä¾‹: v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    name: ãƒ“ãƒ«ãƒ‰ã¨ãƒªãƒªãƒ¼ã‚¹
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: windows-latest
            platform: win32
            arch: x64
          - os: macos-latest
            platform: darwin
            arch: x64
          - os: macos-latest
            platform: darwin
            arch: arm64
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v5
      
    - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm install
      
    - name: å“è³ªãƒã‚§ãƒƒã‚¯
      run: make quality
      continue-on-error: true
      
    - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
      run: npm run build
      env:
        PLATFORM: ${{ matrix.platform }}
        ARCH: ${{ matrix.arch }}
        
    - name: é…å¸ƒç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ
      run: npm run dist
      continue-on-error: true
      
    - name: ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: murmur-${{ matrix.platform }}-${{ matrix.arch }}
        path: dist/
        retention-days: 30

  create-release:
    name: GitHubãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    runs-on: ubuntu-latest
    needs: build-and-release
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v5
      
    - name: ã™ã¹ã¦ã®ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        
    - name: ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆç”Ÿæˆ
      id: release-notes
      run: |
        VERSION=${{ github.event.inputs.version || github.ref_name }}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        
        cat > release-notes.md << EOF
        # Murmur ${VERSION}
        
        ## ðŸŽ‰ æ–°æ©Ÿèƒ½
        - éŸ³å£°éŒ²éŸ³ã‹ã‚‰Obsidianä¿å­˜ã¾ã§ã®å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
        - OpenAI Whisper APIã«ã‚ˆã‚‹é«˜ç²¾åº¦éŸ³å£°èªè­˜
        - GPT APIã«ã‚ˆã‚‹ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãƒ»è¦ç´„
        - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³é‡ãƒ¡ãƒ¼ã‚¿ãƒ¼
        - ç›´æ„Ÿçš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹
        
        ## ðŸ”§ æŠ€è¡“ä»•æ§˜
        - Electronãƒ™ãƒ¼ã‚¹ã®ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒª
        - Node.js v18+ å¯¾å¿œ
        - macOS, Windows, Linux å¯¾å¿œ
        
        ## ðŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        å¯¾å¿œã™ã‚‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
        
        ## âš™ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        1. OpenAI APIã‚­ãƒ¼ã‚’è¨­å®š
        2. Obsidian Vaultãƒ‘ã‚¹ã‚’æŒ‡å®š
        3. éŸ³å£°éŒ²éŸ³é–‹å§‹ï¼
        
        ---
        ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
        EOF
        
    - name: GitHubãƒªãƒªãƒ¼ã‚¹ä½œæˆ
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.release-notes.outputs.version }}
        name: Murmur ${{ steps.release-notes.outputs.version }}
        body_path: release-notes.md
        files: artifacts/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}