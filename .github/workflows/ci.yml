name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# Cancel in-progress workflows when a new one starts
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22.x'

jobs:
  # é«˜é€Ÿãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯
  fast-checks:
    name: ðŸš€ é«˜é€Ÿå“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci
      
    - name: ç’°å¢ƒæƒ…å ±ã‚’è¡¨ç¤º
      run: make env-info
      
    - name: TypeScriptåž‹ãƒã‚§ãƒƒã‚¯ (åŽ³æ ¼)
      run: |
        echo "ðŸ” TypeScript strict mode compilation check"
        npm run type-check
        
    - name: ESLint (åŽ³æ ¼)
      run: |
        echo "ðŸ” ESLint code quality check"
        make lint

  # åŒ…æ‹¬çš„å“è³ªãƒã‚§ãƒƒã‚¯
  quality-check:
    name: ðŸ“‹ åŒ…æ‹¬çš„å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    needs: fast-checks
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        node-version: [20.x, 22.x, 24.x]
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.js ${{ matrix.node-version }} ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci
      
    - name: çµ±åˆå“è³ªãƒã‚§ãƒƒã‚¯ (åŽ³æ ¼)
      run: |
        echo "ðŸŽ¯ Running comprehensive quality checks"
        make quality
        
    - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (åŽ³æ ¼)
      run: |
        echo "ðŸ§ª Running test suite"
        make test
        
    - name: ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ (åŽ³æ ¼)
      run: |
        echo "ðŸ”¨ Building application"
        make build

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ (å¼·åŒ–ç‰ˆ)
  security-scan:
    name: ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    needs: fast-checks
    timeout-minutes: 10
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci
      
    - name: ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ (åŽ³æ ¼)
      run: |
        echo "ðŸ” Dependency vulnerability scan"
        npm audit --audit-level=moderate
        
    - name: License compliance check
      run: |
        echo "ðŸ“œ License compliance check"
        npx license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD" --summary || echo "âš ï¸  License check completed with warnings"
        
    - name: Secret scanning (basic)
      run: |
        echo "ðŸ” Basic secret scanning"
        ! grep -r -i "api.key\|password\|secret\|token" --include="*.js" --include="*.ts" --include="*.json" . || (echo "âš ï¸  Potential secrets detected" && exit 1)

  # ãƒžãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build-test:
    name: ðŸ—ï¸ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [fast-checks, quality-check]
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci
      
    - name: TypeScript compilation
      run: |
        echo "ðŸ”§ TypeScript compilation check"
        npm run type-check
        
    - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
      run: |
        echo "ðŸ—ï¸  Building application for ${{ matrix.os }}"
        npm run build
        
    - name: ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã®æ¤œè¨¼
      run: |
        echo "âœ… Verifying build artifacts"
        ls -la dist/ || echo "No dist directory found"
        
    - name: ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (Linux)
      if: matrix.os == 'ubuntu-latest' && github.event_name == 'push'
      uses: actions/upload-artifact@v4
      with:
        name: murmur-linux-build-${{ github.sha }}
        path: dist/
        retention-days: 7

  # PRå“è³ªã‚²ãƒ¼ãƒˆ (åŽ³æ ¼ç‰ˆ)
  pr-quality-gate:
    name: ðŸŽ¯ PRå“è³ªã‚²ãƒ¼ãƒˆ
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [quality-check, security-scan, build-test]
    timeout-minutes: 5
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci
      
    - name: PRæœ€çµ‚å“è³ªãƒã‚§ãƒƒã‚¯
      run: |
        echo "ðŸŽ¯ Final PR quality check"
        make pr-ready
        
    - name: PRå“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        echo "## ðŸŽ¯ PRå“è³ªãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… å®Œäº†ãƒã‚§ãƒƒã‚¯é …ç›®" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **TypeScriptåž‹ãƒã‚§ãƒƒã‚¯**: åŽ³æ ¼ãƒ¢ãƒ¼ãƒ‰é€šéŽ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **ESLintå“è³ªãƒã‚§ãƒƒã‚¯**: å…¨ãƒ«ãƒ¼ãƒ«é€šéŽ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**: å…¨ãƒ†ã‚¹ãƒˆé€šéŽ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³**: è„†å¼±æ€§ãªã—" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **ãƒžãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ‰**: å…¨OSå¯¾å¿œç¢ºèª" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **ã‚³ãƒ¼ãƒ‰å“è³ª**: Make quality å…¨é€šéŽ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ ãƒžãƒ¼ã‚¸æº–å‚™çŠ¶æ³" >> $GITHUB_STEP_SUMMARY
        echo "**ã“ã®PRã¯å…¨ã¦ã®å“è³ªåŸºæº–ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãŠã‚Šã€ãƒžãƒ¼ã‚¸æº–å‚™å®Œäº†ã§ã™ï¼**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š å“è³ªçµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
        echo "- **Node.jså¯¾å¿œ**: 20.x, 22.x, 24.x" >> $GITHUB_STEP_SUMMARY
        echo "- **OSå¯¾å¿œ**: Ubuntu, Windows, macOS" >> $GITHUB_STEP_SUMMARY
        echo "- **TypeScript**: Strict mode æœ‰åŠ¹" >> $GITHUB_STEP_SUMMARY

  # æˆåŠŸé€šçŸ¥ (main branch push ã®ã¿)
  deployment-ready:
    name: ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [quality-check, security-scan, build-test]
    timeout-minutes: 2
    
    steps:
    - name: ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†é€šçŸ¥
      run: |
        echo "## ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**main ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ãŒæˆåŠŸã—ã€å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ãŒé€šéŽã—ã¾ã—ãŸã€‚**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… å®Œäº†é …ç›®" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ—ï¸  ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ æˆæžœç‰©ç”Ÿæˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ãªçŠ¶æ…‹ã§ã™ï¼**" >> $GITHUB_STEP_SUMMARY